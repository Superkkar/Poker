<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poker Tracker - Contabilit√† Partite dal Vivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a4d0a 0%, #064206 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Setup Screen */
        .setup-screen {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid #ffd700;
        }

        .setup-screen h1 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 25px;
            font-size: 26px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .setup-group {
            margin-bottom: 20px;
        }

        .setup-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
        }

        .chips-mode-toggle {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chips-mode-toggle:hover {
            border-color: rgba(255, 215, 0, 0.5);
            background: rgba(0, 0, 0, 0.5);
        }

        .chips-mode-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #ffd700;
        }

        .chips-mode-toggle label {
            margin: 0;
            cursor: pointer;
            font-size: 15px;
            color: #ffd700;
            user-select: none;
        }

        .setup-group input, .setup-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }

        .setup-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .player-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .player-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .player-input-row input {
            flex: 1;
        }

        .player-chips-input {
            width: 100px;
            flex-shrink: 0;
        }

        .player-number {
            color: #ffd700;
            font-weight: bold;
            min-width: 25px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Game Screen */
        .game-screen {
            display: none;
        }

        .game-header {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ffd700;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pot-display {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .pot-label {
            color: #ffd700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pot-amount {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .phase-display {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }

        .phase-label {
            color: #ffd700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-name {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
        }

        .dealer-info {
            text-align: center;
            width: 100%;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 215, 0, 0.3);
        }

        .dealer-label {
            color: #ffd700;
            font-size: 12px;
        }

        .dealer-name {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-top: 3px;
        }

        .btn-next-dealer {
            background: rgba(255, 215, 0, 0.2);
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-next-dealer:active {
            background: rgba(255, 215, 0, 0.4);
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #555;
            border-radius: 10px;
            padding: 12px;
            position: relative;
            transition: all 0.2s;
        }

        .player-card.is-dealer {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .player-card.has-bet {
            border-color: #4CAF50;
        }

        .player-card.folded {
            opacity: 0.5;
            border-color: #666;
            background: rgba(0, 0, 0, 0.8);
        }

        .player-card.folded .player-name {
            color: #999;
            text-decoration: line-through;
        }

        .player-card.checked {
            border-color: #FFC107;
        }

        .fold-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(244, 67, 54, 0.9);
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            z-index: 10;
        }

        .check-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 193, 7, 0.95);
            color: #000;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 11px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.4);
            letter-spacing: 0.5px;
        }

        .dealer-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffd700;
            color: #000;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .blind-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #4CAF50;
            color: #fff;
            padding: 3px 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .blind-badge.big {
            background: #f44336;
        }

        .player-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #ffd700;
        }

        .player-chips {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #fff;
        }

        .euro-value {
            font-size: 11px;
            color: #aaa;
            font-weight: normal;
            margin-left: 5px;
        }

        .euro-value {
            font-size: 10px;
            color: #4CAF50;
            font-weight: normal;
            margin-left: 6px;
            opacity: 0.7;
            display: inline-block;
        }

        .player-bet {
            font-size: 13px;
            color: #4CAF50;
            margin-bottom: 8px;
            min-height: 18px;
        }

        .player-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .quick-bet-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .btn-quick-player-bet {
            padding: 10px 5px;
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-quick-player-bet:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        }

        .advanced-actions {
            display: flex;
            gap: 6px;
        }

        .btn-bet {
            flex: 1;
            padding: 10px;
            background: rgba(33, 150, 243, 0.3);
            color: #fff;
            border: 2px solid #2196F3;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-bet:active {
            transform: scale(0.95);
        }

        .btn-allin {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-allin:active {
            transform: scale(0.95);
        }

        .btn-fold {
            flex: 1;
            padding: 10px;
            background: rgba(128, 128, 128, 0.3);
            color: #fff;
            border: 2px solid #888;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-fold:active {
            transform: scale(0.95);
            background: rgba(128, 128, 128, 0.5);
        }

        .btn-check {
            flex: 1;
            padding: 10px;
            background: rgba(255, 193, 7, 0.3);
            color: #FFC107;
            border: 2px solid #FFC107;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-check:active {
            transform: scale(0.95);
            background: rgba(255, 193, 7, 0.5);
        }

        .btn-call {
            flex: 1;
            padding: 10px;
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            border: 2px solid #4CAF50;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-call:active {
            transform: scale(0.95);
            background: rgba(76, 175, 80, 0.5);
        }

        .secondary-actions {
            display: flex;
            gap: 6px;
            margin-top: 5px;
        }

        .tertiary-actions {
            display: flex;
            gap: 6px;
            margin-top: 5px;
        }

        .phase-controls {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ffd700;
        }

        .phase-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .btn-phase {
            padding: 12px;
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            color: #ffd700;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-phase:active {
            background: rgba(255, 215, 0, 0.4);
        }

        .btn-phase.btn-danger {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
            color: #f44336;
        }

        .btn-phase.btn-success {
            background: rgba(76, 175, 80, 0.2);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .settings-button {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffd700;
            color: #ffd700;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #0a4d0a 0%, #064206 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            color: #ffd700;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .bet-input-section {
            margin-bottom: 20px;
        }

        .quick-bets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .btn-quick-bet {
            padding: 12px;
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196F3;
            color: #fff;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-quick-bet:active {
            background: rgba(33, 150, 243, 0.5);
        }

        .manual-bet-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-modal {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-modal-confirm {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #fff;
        }

        .btn-modal-cancel {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 2px solid #fff;
        }

        .winner-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .winner-option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ffd700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .winner-option:active {
            background: rgba(255, 215, 0, 0.3);
        }

        .winner-option-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .winner-option-chips {
            font-size: 14px;
            color: #aaa;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .setting-item {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .setting-label {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        .setting-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffd700;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }

        .rebuy-player-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rebuy-player-info {
            flex: 1;
        }

        .rebuy-player-name {
            color: #ffd700;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .rebuy-player-stats {
            color: #aaa;
            font-size: 12px;
        }

        .rebuy-player-stats .highlight {
            color: #4CAF50;
            font-weight: bold;
        }

        .btn-rebuy-settings {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-rebuy-settings:active {
            background: rgba(76, 175, 80, 0.5);
        }

        .hidden {
            display: none !important;
        }

        /* Visualizzazione Tavolo */
        .table-preview {
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .table-preview-title {
            color: #ffd700;
            font-size: 14px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .poker-table-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            padding-top: 60%; /* Aspect ratio */
        }

        .poker-table {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 85%;
            background: linear-gradient(135deg, #0a4d0a 0%, #064206 100%);
            border-radius: 50%;
            border: 8px solid #8B4513;
            box-shadow: 
                0 0 0 3px #FFD700,
                inset 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .table-player {
            position: absolute;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: bold;
            color: #ffd700;
            white-space: nowrap;
            text-align: center;
            min-width: 60px;
        }

        .table-dealer-chip {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #000;
            border: 2px solid #FFA500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        /* Stack Chart */
        .stack-chart-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .stack-chart-title {
            color: #ffd700;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .chart-canvas {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #fff;
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Animations */
        @keyframes chipGain {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #4CAF50; }
            100% { transform: scale(1); }
        }

        @keyframes chipLoss {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #f44336; }
            100% { transform: scale(1); }
        }

        .chip-animation-gain {
            animation: chipGain 0.5s ease;
        }

        .chip-animation-loss {
            animation: chipLoss 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 400px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-bets {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Game Log */
        .game-log {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ffd700;
            max-height: 150px;
            overflow-y: auto;
        }

        .game-log-title {
            color: #ffd700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .log-entry {
            color: #fff;
            font-size: 13px;
            padding: 4px 8px;
            margin-bottom: 3px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            border-left: 3px solid #ffd700;
        }

        .log-entry.log-bet {
            border-left-color: #2196F3;
        }

        .log-entry.log-fold {
            border-left-color: #f44336;
        }

        .log-entry.log-check {
            border-left-color: #FFC107;
        }

        .log-entry.log-phase {
            border-left-color: #4CAF50;
            font-weight: bold;
        }

        .log-entry.log-win {
            border-left-color: #ffd700;
            font-weight: bold;
        }

        /* Side Pots Display */
        .pots-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .side-pot {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid #FFC107;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: #FFC107;
        }

        /* Rebuy Button */
        .btn-rebuy {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        .btn-rebuy:active {
            background: rgba(76, 175, 80, 0.5);
        }

        .btn-edit-chips {
            background: rgba(33, 150, 243, 0.3);
            border: 2px solid #2196F3;
            color: #2196F3;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }

        .btn-edit-chips:active {
            background: rgba(33, 150, 243, 0.5);
        }

        .chip-adjustment-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .btn-chip-adjust {
            padding: 10px;
            border: 2px solid #ffd700;
            border-radius: 6px;
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-chip-adjust:active {
            background: rgba(255, 215, 0, 0.4);
        }

        .btn-chip-adjust.negative {
            border-color: #f44336;
            color: #f44336;
            background: rgba(244, 67, 54, 0.2);
        }

        .btn-chip-adjust.negative:active {
            background: rgba(244, 67, 54, 0.4);
        }

        .btn-chip-adjust.positive {
            border-color: #4CAF50;
            color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .btn-chip-adjust.positive:active {
            background: rgba(76, 175, 80, 0.4);
        }

        .current-chips-display {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #ffd700;
        }

        .current-chips-label {
            color: #aaa;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .current-chips-value {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
        }

        /* Summary Screen */
        .summary-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            overflow-y: auto;
            padding: 20px;
        }

        .summary-content {
            max-width: 600px;
            margin: 0 auto;
            background: linear-gradient(135deg, #0a4d0a 0%, #064206 100%);
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            min-height: min-content;
        }

        .summary-title {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .summary-players-container {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            padding-right: 5px;
            margin-bottom: 20px;
        }

        .player-summary {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border: 2px solid #555;
        }

        .player-summary.winner {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }

        .player-summary.loser {
            border-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .summary-player-name {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 14px;
        }

        .summary-stat {
            color: #fff;
        }

        .summary-stat-label {
            color: #aaa;
            font-size: 12px;
        }

        .profit {
            color: #4CAF50;
            font-weight: bold;
        }

        .loss {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <h1>üÉè Poker Tracker</h1>
            <p style="text-align: center; color: #aaa; margin-bottom: 25px; font-size: 13px;">
                Contabilit√† per partite dal vivo
            </p>

            <div class="setup-group">
                <label for="numPlayers">Numero di giocatori</label>
                <select id="numPlayers">
                    <option value="2">2 giocatori</option>
                    <option value="3">3 giocatori</option>
                    <option value="4">4 giocatori</option>
                    <option value="5">5 giocatori</option>
                    <option value="6" selected>6 giocatori</option>
                    <option value="7">7 giocatori</option>
                    <option value="8">8 giocatori</option>
                    <option value="9">9 giocatori</option>
                    <option value="10">10 giocatori</option>
                </select>
            </div>

            <div class="setup-group">
                <div class="chips-mode-toggle" onclick="document.getElementById('sameChipsForAll').click();">
                    <input type="checkbox" id="sameChipsForAll" checked onchange="toggleChipsMode()" onclick="event.stopPropagation();">
                    <label for="sameChipsForAll">üí∞ Stesse chips per tutti</label>
                </div>
            </div>

            <div class="setup-group" id="globalChipsGroup">
                <label for="startingChips">Chips iniziali per giocatore</label>
                <input type="number" id="startingChips" value="1000" min="100" step="100">
            </div>

            <div class="setup-group">
                <label>Nomi giocatori <span id="chipsLabel" style="display: none;">e chips iniziali</span></label>
                <div class="player-inputs" id="playerInputs"></div>
            </div>

            <div class="table-preview">
                <div class="table-preview-title">üëÅÔ∏è Anteprima Tavolo</div>
                <div class="poker-table-container">
                    <div class="poker-table" id="previewTable">
                        <div class="table-dealer-chip">D</div>
                    </div>
                </div>
            </div>

            <div class="setup-group">
                <label for="chipValue">Valore di scambio (0 = disabilitato)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="chipValue" value="0" min="0" step="50" style="flex: 1;" placeholder="es. 500">
                    <span style="color: #ffd700; font-size: 14px;">chips = 1‚Ç¨</span>
                </div>
                <small style="color: #aaa; font-size: 12px; margin-top: 5px; display: block;">
                    Esempio: 500 chips = 1‚Ç¨ ‚Üí 1000 chips = 2‚Ç¨
                </small>
            </div>

            <div class="setup-group">
                <label style="margin-bottom: 10px; display: block;">üí∞ Modalit√† Puntate</label>
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="radio" name="blindMode" value="ante" id="modeAnte" checked onchange="toggleBlindMode()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: #ffd700; font-size: 16px;">Ante</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                        <input type="radio" name="blindMode" value="blinds" id="modeBlinds" onchange="toggleBlindMode()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: #ffd700; font-size: 16px;">Small & Big Blind</span>
                    </label>
                </div>
                
                <div id="anteGroup">
                    <label for="anteAmount" style="font-size: 14px; color: #aaa;">Importo Ante (tutti pagano)</label>
                    <input type="number" id="anteAmount" value="0" min="0" step="5" style="width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; margin-top: 5px;">
                    <small style="color: #888; font-size: 11px; display: block; margin-top: 3px;">0 = nessuna ante</small>
                </div>
                
                <div id="blindsGroup" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <label for="smallBlind" style="font-size: 14px; color: #aaa;">Small Blind (SB)</label>
                        <input type="number" id="smallBlind" value="5" min="1" step="5" style="width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; margin-top: 5px;">
                        <small style="color: #888; font-size: 11px; display: block; margin-top: 3px;">Giocatore dopo il dealer</small>
                    </div>
                    <div>
                        <label for="bigBlind" style="font-size: 14px; color: #aaa;">Big Blind (BB)</label>
                        <input type="number" id="bigBlind" value="10" min="1" step="5" style="width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px; margin-top: 5px;">
                        <small style="color: #888; font-size: 11px; display: block; margin-top: 3px;">Due giocatori dopo il dealer</small>
                    </div>
                </div>
            </div>

            <div class="setup-group">
                <label for="initialDealer">üÖì Dealer iniziale</label>
                <select id="initialDealer" style="width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px;">
                    <!-- Popolato dinamicamente -->
                </select>
            </div>

            <button class="btn btn-primary" onclick="startGame()">Inizia Partita</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <button class="settings-button" onclick="openSettings()">‚öôÔ∏è</button>

            <div class="game-header">
                <div class="game-info">
                    <div class="pot-display">
                        <div class="pot-label">Piatto</div>
                        <div class="pot-amount" id="potAmount">0</div>
                    </div>
                    <div class="phase-display">
                        <div class="phase-label">Fase</div>
                        <div class="phase-name" id="phaseName">Pre-Flop</div>
                    </div>
                </div>
                <div class="dealer-info">
                    <div class="dealer-label">Dealer</div>
                    <div class="dealer-name" id="dealerName">-</div>
                    <button class="btn-next-dealer" onclick="nextDealer()">Prossimo Dealer ‚ûú</button>
                </div>
            </div>

            <div class="game-log" id="gameLogContainer">
                <div class="game-log-title">üìã Log Mano</div>
                <div id="gameLog"></div>
            </div>

            <div class="players-grid" id="playersGrid"></div>

            <div class="phase-controls">
                <div class="phase-buttons">
                    <button class="btn-phase" onclick="nextPhase()">Prossima Fase ‚ûú</button>
                    <button class="btn-phase btn-success" onclick="openWinnerModal()">Assegna Piatto</button>
                    <button class="btn-phase btn-danger" onclick="resetHand()">Nuova Mano</button>
                    <button class="btn-phase" onclick="undoLastBet()" id="undoButton">‚Ü∂ Annulla</button>
                    <button class="btn-phase" onclick="showSummary()" style="grid-column: span 2;">üìä Riepilogo Serata</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bet Modal -->
    <div class="modal" id="betModal">
        <div class="modal-content">
            <div class="modal-header" id="betModalTitle">Puntata</div>
            
            <div class="bet-input-section">
                <div class="quick-bets" id="quickBets"></div>
                <input type="number" class="manual-bet-input" id="betInput" placeholder="Importo puntata" min="0">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeBetModal()">Annulla</button>
                <button class="btn-modal btn-modal-confirm" onclick="confirmBet()">Conferma</button>
            </div>
        </div>
    </div>

    <!-- All-In Confirmation Modal -->
    <div class="modal" id="allinModal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Conferma All-In</div>
            <p style="text-align: center; margin-bottom: 20px; font-size: 16px;" id="allinMessage"></p>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeAllinModal()">Annulla</button>
                <button class="btn-modal btn-modal-confirm" onclick="confirmAllin()">Conferma All-In</button>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div class="modal" id="winnerModal">
        <div class="modal-content">
            <div class="modal-header">Seleziona Vincitore</div>
            <div class="winner-list" id="winnerList"></div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeWinnerModal()">Annulla</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">‚öôÔ∏è Impostazioni</div>
            
            <div class="settings-content">
                <div class="setting-item">
                    <label class="setting-label">Ante per mano</label>
                    <input type="number" id="settingsAnte" min="0" step="5">
                </div>

                <div class="setting-item">
                    <label class="setting-label">Valore di scambio</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" id="settingsChipValue" min="0" step="50" style="flex: 1; width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px;" placeholder="es. 500">
                        <span style="color: #ffd700; font-size: 14px; white-space: nowrap;">chips = 1‚Ç¨</span>
                    </div>
                </div>

                <div class="setting-item">
                    <label class="setting-label">Numero giocatori</label>
                    <select id="settingsNumPlayers" style="width: 100%; padding: 10px; border: 2px solid #ffd700; border-radius: 6px; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 16px;">
                        <option value="2">2 giocatori</option>
                        <option value="3">3 giocatori</option>
                        <option value="4">4 giocatori</option>
                        <option value="5">5 giocatori</option>
                        <option value="6">6 giocatori</option>
                        <option value="7">7 giocatori</option>
                        <option value="8">8 giocatori</option>
                        <option value="9">9 giocatori</option>
                        <option value="10">10 giocatori</option>
                    </select>
                </div>

                <div id="settingsPlayerInputs"></div>

                <div class="setting-item" style="margin-top: 20px;">
                    <label class="setting-label">üí∞ Rebuy Giocatori</label>
                    <div id="rebuyManagementList" style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;"></div>
                </div>

                <div class="setting-item" style="margin-top: 20px; padding: 15px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; border: 2px solid rgba(255, 215, 0, 0.3);">
                    <label class="setting-label" style="color: #ffd700; margin-bottom: 10px; display: block;">üìä Totale Chips in Gioco</label>
                    <div id="totalChipsDisplay" style="display: flex; flex-direction: column; gap: 8px;"></div>
                </div>

                <button class="btn btn-primary" onclick="applySettings()">Applica Modifiche</button>
                <button class="btn-modal btn-modal-cancel" style="width: 100%; margin-top: 10px;" onclick="closeSettings()">Chiudi</button>
                <button class="btn-phase btn-danger" style="width: 100%; margin-top: 15px; padding: 12px;" onclick="if(confirm('Cancellare tutti i dati salvati? Questa azione non pu√≤ essere annullata.')) { clearSavedGame(); alert('Dati cancellati!'); }">üóëÔ∏è Cancella Salvataggio</button>
            </div>
        </div>
    </div>

    <!-- Split Pot Modal -->
    <div class="modal" id="splitPotModal">
        <div class="modal-content">
            <div class="modal-header">‚ûó Dividi Piatto</div>
            <p style="text-align: center; margin-bottom: 15px; color: #aaa;">Seleziona i vincitori (minimo 2, massimo tutti)</p>
            <div class="winner-list" id="splitWinnerList"></div>
            <div style="text-align: center; margin: 15px 0; padding: 10px; background: rgba(255, 193, 7, 0.1); border-radius: 6px; border: 1px solid #FFC107;">
                <div style="color: #FFC107; font-size: 12px; margin-bottom: 5px;">SELEZIONATI</div>
                <div id="selectedWinnersCount" style="color: #fff; font-size: 18px; font-weight: bold;">0 giocatori</div>
                <div id="splitAmountPreview" style="color: #aaa; font-size: 14px; margin-top: 5px;"></div>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeSplitPotModal()">Annulla</button>
                <button class="btn-modal btn-modal-confirm" onclick="confirmSplitPot()">Dividi Piatto</button>
            </div>
        </div>
    </div>

    <!-- Rebuy Modal -->
    <div class="modal" id="rebuyModal">
        <div class="modal-content">
            <div class="modal-header">üí∞ Rebuy</div>
            <p style="text-align: center; margin-bottom: 15px;" id="rebuyPlayerName"></p>
            <div class="setup-group">
                <label>Importo rebuy</label>
                <input type="number" id="rebuyAmount" value="1000" min="100" step="100" class="manual-bet-input">
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeRebuyModal()">Annulla</button>
                <button class="btn-modal btn-modal-confirm" onclick="confirmRebuy()">Conferma Rebuy</button>
            </div>
        </div>
    </div>

    <!-- Edit Chips Modal -->
    <div class="modal" id="editChipsModal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Modifica Chips Manuale</div>
            <p style="text-align: center; margin-bottom: 15px; color: #aaa;" id="editChipsPlayerName"></p>
            
            <div class="current-chips-display">
                <div class="current-chips-label">Chips Attuali</div>
                <div class="current-chips-value" id="currentChipsDisplay">0</div>
            </div>

            <div class="chip-adjustment-buttons">
                <button class="btn-chip-adjust negative" onclick="adjustChips(-100)">-100</button>
                <button class="btn-chip-adjust negative" onclick="adjustChips(-50)">-50</button>
                <button class="btn-chip-adjust negative" onclick="adjustChips(-10)">-10</button>
                <button class="btn-chip-adjust positive" onclick="adjustChips(10)">+10</button>
                <button class="btn-chip-adjust positive" onclick="adjustChips(50)">+50</button>
                <button class="btn-chip-adjust positive" onclick="adjustChips(100)">+100</button>
            </div>

            <div class="setup-group">
                <label>Oppure imposta un valore specifico</label>
                <input type="number" id="manualChipsInput" min="0" step="10" class="manual-bet-input" placeholder="Inserisci importo esatto">
            </div>

            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeEditChipsModal()">Annulla</button>
                <button class="btn-modal btn-modal-confirm" onclick="confirmEditChips()">Applica</button>
            </div>
        </div>
    </div>

    <!-- Summary Screen -->
    <div class="summary-screen" id="summaryScreen">
        <div class="summary-content">
            <div class="summary-title">üìä Riepilogo Serata</div>
            
            <div class="stack-chart-container">
                <div class="stack-chart-title">üìà Andamento Stack</div>
                <div id="stackChartCanvas"></div>
            </div>
            
            <div class="summary-players-container">
                <div id="summaryPlayers"></div>
            </div>
            <button class="btn btn-primary" onclick="exportJSON()" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);">üìÑ Export JSON</button>
            <button class="btn btn-primary" onclick="closeSummary()">Chiudi</button>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            players: [],
            pot: 0,
            phase: 'Pre-Flop',
            dealerIndex: 0,
            blindMode: 'ante', // 'ante' o 'blinds'
            anteAmount: 0,
            smallBlind: 0,
            bigBlind: 0,
            chipValue: 0, // Quante chips per 1 euro (0 = disabilitato)
            currentBets: {},
            currentCall: 0,
            history: [],
            gameLog: [], // Log delle azioni
            initialChips: {}, // Chips iniziali per il riepilogo
            stackHistory: [], // Storia degli stack per i grafici
            handCount: 0, // Numero di mani giocate
            playerStats: {} // Statistiche avanzate per giocatore
        };

        let currentBetPlayer = null;
        let currentAllinPlayer = null;

        const PHASES = ['Pre-Flop', 'Flop', 'Turn', 'River', 'Showdown'];

        // Audio/Vibration feedback
        function hapticFeedback(type = 'light') {
            if (navigator.vibrate) {
                const patterns = {
                    light: 10,
                    medium: 20,
                    heavy: 50,
                    success: [10, 50, 10],
                    error: [20, 100, 20]
                };
                navigator.vibrate(patterns[type] || patterns.light);
            }
        }

        function playSound(type) {
            // Simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                const frequencies = {
                    bet: 400,
                    win: 600,
                    phase: 500,
                    error: 200
                };
                
                oscillator.frequency.value = frequencies[type] || 400;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                // Audio not supported
            }
        }

        // Setup Screen Functions
        document.getElementById('numPlayers').addEventListener('change', () => {
            updatePlayerInputs();
            updateTablePreview();
        });

        function toggleChipsMode() {
            const sameForAll = document.getElementById('sameChipsForAll').checked;
            document.getElementById('globalChipsGroup').style.display = sameForAll ? 'block' : 'none';
            document.getElementById('chipsLabel').style.display = sameForAll ? 'none' : 'inline';
            updatePlayerInputs();
            updateTablePreview();
        }

        function toggleBlindMode() {
            const modeAnte = document.getElementById('modeAnte').checked;
            document.getElementById('anteGroup').style.display = modeAnte ? 'block' : 'none';
            document.getElementById('blindsGroup').style.display = modeAnte ? 'none' : 'block';
        }

        function updatePlayerInputs() {
            const num = parseInt(document.getElementById('numPlayers').value);
            const sameForAll = document.getElementById('sameChipsForAll').checked;
            const container = document.getElementById('playerInputs');
            container.innerHTML = '';

            for (let i = 0; i < num; i++) {
                const row = document.createElement('div');
                row.className = 'player-input-row';
                
                if (sameForAll) {
                    row.innerHTML = `
                        <span class="player-number">${i + 1}.</span>
                        <input type="text" placeholder="Nome giocatore ${i + 1}" id="playerName${i}" value="Giocatore ${i + 1}" onchange="updateTablePreview(); updateDealerSelect();">
                    `;
                } else {
                    row.innerHTML = `
                        <span class="player-number">${i + 1}.</span>
                        <input type="text" placeholder="Nome giocatore ${i + 1}" id="playerName${i}" value="Giocatore ${i + 1}" onchange="updateTablePreview(); updateDealerSelect();">
                        <input type="number" class="player-chips-input" placeholder="Chips" id="playerChips${i}" value="1000" min="100" step="100">
                    `;
                }
                
                container.appendChild(row);
            }
            
            // Popola il selettore del dealer
            updateDealerSelect();
            
            updateTablePreview();
        }

        function updateDealerSelect() {
            const num = parseInt(document.getElementById('numPlayers').value);
            const dealerSelect = document.getElementById('initialDealer');
            const currentValue = dealerSelect.value;
            
            dealerSelect.innerHTML = '';
            for (let i = 0; i < num; i++) {
                const nameInput = document.getElementById(`playerName${i}`);
                const name = nameInput ? (nameInput.value.trim() || `Giocatore ${i + 1}`) : `Giocatore ${i + 1}`;
                
                const option = document.createElement('option');
                option.value = i;
                option.textContent = name;
                dealerSelect.appendChild(option);
            }
            
            // Ripristina il valore precedente se valido
            if (currentValue && parseInt(currentValue) < num) {
                dealerSelect.value = currentValue;
            }
        }

        function updateTablePreview() {
            const num = parseInt(document.getElementById('numPlayers').value);
            const table = document.getElementById('previewTable');
            
            // Rimuovi giocatori esistenti (mantieni solo il dealer chip)
            const existingPlayers = table.querySelectorAll('.table-player');
            existingPlayers.forEach(p => p.remove());
            
            // Posizioni per ogni numero di giocatori (in gradi)
            const positions = {
                2: [0, 180],
                3: [0, 120, 240],
                4: [0, 90, 180, 270],
                5: [0, 72, 144, 216, 288],
                6: [0, 60, 120, 180, 240, 300],
                7: [0, 51.4, 102.8, 154.2, 205.6, 257, 308.4],
                8: [0, 45, 90, 135, 180, 225, 270, 315],
                9: [0, 40, 80, 120, 160, 200, 240, 280, 320],
                10: [0, 36, 72, 108, 144, 180, 216, 252, 288, 324]
            };
            
            const angles = positions[num] || positions[6];
            
            for (let i = 0; i < num; i++) {
                const nameInput = document.getElementById(`playerName${i}`);
                const name = nameInput ? (nameInput.value.trim() || `P${i + 1}`) : `P${i + 1}`;
                
                const player = document.createElement('div');
                player.className = 'table-player';
                player.textContent = name;
                
                // Calcola posizione
                const angle = (angles[i] - 90) * (Math.PI / 180); // -90 per iniziare dall'alto
                const radiusX = 42; // % dal centro
                const radiusY = 40; // % dal centro (leggermente ovale)
                
                const x = 50 + radiusX * Math.cos(angle);
                const y = 50 + radiusY * Math.sin(angle);
                
                player.style.left = `${x}%`;
                player.style.top = `${y}%`;
                
                table.appendChild(player);
            }
        }

        function startGame() {
            const numPlayers = parseInt(document.getElementById('numPlayers').value);
            const sameForAll = document.getElementById('sameChipsForAll').checked;
            const globalChips = parseInt(document.getElementById('startingChips').value);
            const chipValue = parseInt(document.getElementById('chipValue').value) || 0;
            const initialDealer = parseInt(document.getElementById('initialDealer').value) || 0;
            
            // Leggi modalit√† blinds
            const blindMode = document.querySelector('input[name="blindMode"]:checked').value;
            const anteAmount = blindMode === 'ante' ? parseInt(document.getElementById('anteAmount').value) || 0 : 0;
            const smallBlind = blindMode === 'blinds' ? parseInt(document.getElementById('smallBlind').value) || 0 : 0;
            const bigBlind = blindMode === 'blinds' ? parseInt(document.getElementById('bigBlind').value) || 0 : 0;

            if (sameForAll && globalChips < 100) {
                alert('Le chips iniziali devono essere almeno 100');
                return;
            }

            gameState.players = [];
            for (let i = 0; i < numPlayers; i++) {
                const name = document.getElementById(`playerName${i}`).value.trim() || `Giocatore ${i + 1}`;
                let chips;
                
                if (sameForAll) {
                    chips = globalChips;
                } else {
                    chips = parseInt(document.getElementById(`playerChips${i}`).value);
                    if (!chips || chips < 100) {
                        alert(`Le chips per ${name} devono essere almeno 100`);
                        return;
                    }
                }
                
                gameState.players.push({
                    id: i,
                    name: name,
                    chips: chips,
                    bet: 0,
                    folded: false,
                    hasActed: false,
                    hasChecked: false,
                    totalRebuys: 0, // Totale chips acquistate via rebuy
                    rebuyCount: 0 // Numero di rebuy effettuati
                });
            }

            gameState.blindMode = blindMode;
            gameState.anteAmount = anteAmount;
            gameState.smallBlind = smallBlind;
            gameState.bigBlind = bigBlind;
            gameState.chipValue = chipValue;
            gameState.dealerIndex = initialDealer; // Usa il dealer selezionato
            gameState.pot = 0;
            gameState.phase = 'Pre-Flop';
            gameState.currentBets = {};
            gameState.currentCall = 0;
            gameState.history = [];
            gameState.gameLog = [];
            gameState.initialChips = {};
            gameState.stackHistory = [];
            gameState.handCount = 0;

            // Salva le chips iniziali per il riepilogo
            gameState.players.forEach(p => {
                gameState.initialChips[p.id] = p.chips;
                
                // Inizializza statistiche giocatore
                gameState.playerStats[p.id] = {
                    handsPlayed: 0,
                    foldPreFlop: 0,
                    foldFlop: 0,
                    foldTurn: 0,
                    foldRiver: 0,
                    showdownWins: 0,
                    showdownParticipations: 0,
                    timesBroke: 0,
                    totalRebuys: 0
                };
            });

            // Salva primo snapshot dello stack
            saveStackSnapshot();

            addLog(`üéÆ Partita iniziata con ${numPlayers} giocatori`, 'phase');

            // Apply ante or blinds - all'inizio del gioco
            if (gameState.blindMode === 'ante' && gameState.anteAmount > 0) {
                // Modalit√† Ante: tutti pagano
                gameState.players.forEach(player => {
                    if (player.chips >= gameState.anteAmount) {
                        player.chips -= gameState.anteAmount;
                        player.bet = gameState.anteAmount;
                        gameState.pot += gameState.anteAmount;
                    }
                });
                gameState.currentCall = gameState.anteAmount;
                addLog(`üí∞ Ante: ${gameState.anteAmount} chips per giocatore`, 'phase');
            } else if (gameState.blindMode === 'blinds') {
                // Modalit√† Blinds: solo SB e BB pagano
                const sbIndex = (gameState.dealerIndex + 1) % gameState.players.length;
                const bbIndex = (gameState.dealerIndex + 2) % gameState.players.length;
                
                // Small Blind
                const sbPlayer = gameState.players[sbIndex];
                if (sbPlayer.chips >= gameState.smallBlind) {
                    sbPlayer.chips -= gameState.smallBlind;
                    sbPlayer.bet = gameState.smallBlind;
                    gameState.pot += gameState.smallBlind;
                }
                
                // Big Blind
                const bbPlayer = gameState.players[bbIndex];
                if (bbPlayer.chips >= gameState.bigBlind) {
                    bbPlayer.chips -= gameState.bigBlind;
                    bbPlayer.bet = gameState.bigBlind;
                    gameState.pot += gameState.bigBlind;
                }
                
                gameState.currentCall = gameState.bigBlind;
                addLog(`üí∞ Small Blind (${sbPlayer.name}): ${gameState.smallBlind} chips`, 'phase');
                addLog(`üí∞ Big Blind (${bbPlayer.name}): ${gameState.bigBlind} chips`, 'phase');
            }

            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            renderGame();
            saveGame();
            hapticFeedback('success');
            playSound('phase');
        }

        // Game Rendering
        function renderGame() {
            renderPlayers();
            updateGameHeader();
            updateUndoButton();
            updateGameLog();
        }

        function addLog(message, type = 'normal') {
            const timestamp = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            gameState.gameLog.push({ message, type, timestamp });
            
            // Mantieni solo gli ultimi 50 log
            if (gameState.gameLog.length > 50) {
                gameState.gameLog = gameState.gameLog.slice(-50);
            }
            
            updateGameLog();
        }

        function formatEuroValue(chips) {
            if (gameState.chipValue <= 0 || !chips) return '';
            
            const euros = (chips / gameState.chipValue).toFixed(2);
            return `<span class="euro-value">(${euros}‚Ç¨)</span>`;
        }

        function updateGameLog() {
            const logContainer = document.getElementById('gameLog');
            if (!logContainer) return;
            
            // Mostra solo gli ultimi 10 log
            const recentLogs = gameState.gameLog.slice(-10);
            
            logContainer.innerHTML = recentLogs.map(log => 
                `<div class="log-entry log-${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
            
            // Auto-scroll al fondo
            const logBox = document.getElementById('gameLogContainer');
            if (logBox) {
                logBox.scrollTop = logBox.scrollHeight;
            }
        }

        // ===== SPLIT POT =====
        let selectedWinners = [];

        function openSplitPotModal() {
            if (gameState.pot === 0) {
                alert('Il piatto √® vuoto!');
                return;
            }

            selectedWinners = [];
            const winnerList = document.getElementById('splitWinnerList');
            winnerList.innerHTML = '';

            const activePlayers = gameState.players.filter(p => !p.folded);

            if (activePlayers.length === 0) {
                alert('Tutti i giocatori hanno fatto fold!');
                return;
            }

            activePlayers.forEach(player => {
                const option = document.createElement('div');
                option.className = 'winner-option';
                option.style.cursor = 'pointer';
                option.onclick = () => toggleWinnerSelection(player.id, option);
                option.innerHTML = `
                    <div class="winner-option-name">‚òê ${player.name}</div>
                    <div class="winner-option-chips">Chips attuali: ${player.chips}</div>
                `;
                option.dataset.playerId = player.id;
                winnerList.appendChild(option);
            });

            updateSplitPreview();
            document.getElementById('splitPotModal').classList.add('active');
            hapticFeedback('light');
        }

        function toggleWinnerSelection(playerId, element) {
            const index = selectedWinners.indexOf(playerId);
            if (index > -1) {
                selectedWinners.splice(index, 1);
                element.querySelector('.winner-option-name').innerHTML = 
                    `‚òê ${gameState.players[playerId].name}`;
                element.style.background = 'rgba(255, 255, 255, 0.1)';
            } else {
                selectedWinners.push(playerId);
                element.querySelector('.winner-option-name').innerHTML = 
                    `‚òë ${gameState.players[playerId].name}`;
                element.style.background = 'rgba(76, 175, 80, 0.2)';
            }
            
            updateSplitPreview();
        }

        function updateSplitPreview() {
            const countElement = document.getElementById('selectedWinnersCount');
            const previewElement = document.getElementById('splitAmountPreview');
            
            const count = selectedWinners.length;
            countElement.textContent = `${count} giocator${count === 1 ? 'e' : 'i'}`;
            
            if (count >= 2) {
                const totalPot = gameState.pot;
                const sharePerPlayer = Math.floor(totalPot / count);
                const remainder = totalPot % count;
                
                if (remainder > 0) {
                    previewElement.textContent = `${sharePerPlayer} chips ciascuno (+${remainder} al primo)`;
                } else {
                    previewElement.textContent = `${sharePerPlayer} chips ciascuno`;
                }
                previewElement.style.color = '#4CAF50';
            } else if (count === 1) {
                previewElement.textContent = 'Seleziona almeno un altro giocatore';
                previewElement.style.color = '#FFC107';
            } else {
                previewElement.textContent = 'Seleziona i vincitori per vedere la divisione';
                previewElement.style.color = '#aaa';
            }
        }

        function closeSplitPotModal() {
            document.getElementById('splitPotModal').classList.remove('active');
            selectedWinners = [];
            updateSplitPreview();
        }

        function confirmSplitPot() {
            if (selectedWinners.length < 2) {
                alert('Seleziona almeno 2 vincitori!');
                return;
            }

            const totalPot = gameState.pot;
            const numWinners = selectedWinners.length;
            const sharePerPlayer = Math.floor(totalPot / numWinners);
            const remainder = totalPot % numWinners;

            const winnerNames = [];
            
            selectedWinners.forEach((playerId, index) => {
                const player = gameState.players[playerId];
                let share = sharePerPlayer;
                // Il primo giocatore prende anche il resto
                if (index === 0 && remainder > 0) {
                    share += remainder;
                }
                
                player.chips += share;
                winnerNames.push(player.name);
                animateChipChange(playerId, 'gain');
            });

            // Log dettagliato
            const winnerList = winnerNames.join(', ');
            if (remainder > 0) {
                addLog(`üèÜ Split pot tra ${numWinners} giocatori: ${winnerList} (${sharePerPlayer} chips ciascuno, +${remainder} a ${winnerNames[0]})`, 'win');
            } else {
                addLog(`üèÜ Split pot tra ${numWinners} giocatori: ${winnerList} (${sharePerPlayer} chips ciascuno)`, 'win');
            }

            gameState.pot = 0;
            gameState.currentCall = 0;
            gameState.players.forEach(p => {
                p.bet = 0;
                p.folded = false;
                p.hasActed = false;
                p.hasChecked = false;
            });

            closeSplitPotModal();
            renderGame();
            saveStackSnapshot(); // Salva snapshot dopo split pot
            saveGame();
            hapticFeedback('success');
            playSound('win');

            setTimeout(() => {
                if (confirm(`Split pot assegnato! Iniziare nuova mano?`)) {
                    resetHand();
                }
            }, 500);
        }

        // ===== REBUY =====
        let currentRebuyPlayer = null;

        function openRebuyModal(playerId) {
            currentRebuyPlayer = playerId;
            const player = gameState.players[playerId];
            
            document.getElementById('rebuyPlayerName').textContent = 
                `${player.name} - Chips attuali: ${player.chips}`;
            document.getElementById('rebuyAmount').value = 1000;
            
            document.getElementById('rebuyModal').classList.add('active');
            hapticFeedback('light');
        }

        function closeRebuyModal() {
            document.getElementById('rebuyModal').classList.remove('active');
            currentRebuyPlayer = null;
        }

        function confirmRebuy() {
            const amount = parseInt(document.getElementById('rebuyAmount').value);
            
            if (!amount || amount < 100) {
                alert('L\'importo del rebuy deve essere almeno 100');
                return;
            }

            const player = gameState.players[currentRebuyPlayer];
            const wasBroke = player.chips === 0;
            
            player.chips += amount;
            player.totalRebuys += amount;
            player.rebuyCount += 1;
            
            // Traccia statistiche
            if (gameState.playerStats[currentRebuyPlayer]) {
                gameState.playerStats[currentRebuyPlayer].totalRebuys += amount;
                if (wasBroke) {
                    gameState.playerStats[currentRebuyPlayer].timesBroke++;
                }
            }
            
            addLog(`üí∞ ${player.name} fa rebuy di ${amount} chips (Totale rebuy: ${player.totalRebuys})`, 'phase');
            
            animateChipChange(currentRebuyPlayer, 'gain');
            closeRebuyModal();
            renderGame();
            saveStackSnapshot(); // Salva snapshot dopo rebuy
            saveGame();
            hapticFeedback('success');
            playSound('win');
        }

        // ===== EDIT CHIPS MANUAL =====
        let currentEditChipsPlayer = null;

        function openEditChipsModal(playerId) {
            currentEditChipsPlayer = playerId;
            const player = gameState.players[playerId];
            
            document.getElementById('editChipsPlayerName').textContent = player.name;
            document.getElementById('currentChipsDisplay').textContent = player.chips;
            document.getElementById('manualChipsInput').value = '';
            
            document.getElementById('editChipsModal').classList.add('active');
            hapticFeedback('light');
        }

        function closeEditChipsModal() {
            document.getElementById('editChipsModal').classList.remove('active');
            currentEditChipsPlayer = null;
        }

        function adjustChips(amount) {
            const player = gameState.players[currentEditChipsPlayer];
            const newAmount = Math.max(0, player.chips + amount);
            
            player.chips = newAmount;
            document.getElementById('currentChipsDisplay').textContent = newAmount;
            
            hapticFeedback('light');
        }

        function confirmEditChips() {
            const manualInput = document.getElementById('manualChipsInput').value;
            const player = gameState.players[currentEditChipsPlayer];
            
            // Se c'√® un valore manuale, usalo
            if (manualInput !== '') {
                const manualAmount = parseInt(manualInput);
                if (isNaN(manualAmount) || manualAmount < 0) {
                    alert('Inserisci un valore valido (0 o maggiore)');
                    return;
                }
                player.chips = manualAmount;
            }
            // Altrimenti usa il valore gi√† modificato con i bottoni
            
            const finalAmount = player.chips;
            
            addLog(`‚úèÔ∏è Chips di ${player.name} modificate manualmente: ${finalAmount}`, 'phase');
            
            animateChipChange(currentEditChipsPlayer, finalAmount > 0 ? 'gain' : 'loss');
            closeEditChipsModal();
            renderGame();
            saveStackSnapshot(); // Salva snapshot dopo modifica
            saveGame();
            hapticFeedback('success');
            playSound('bet');
        }

        // ===== SUMMARY =====
        function showSummary() {
            const summaryPlayers = document.getElementById('summaryPlayers');
            summaryPlayers.innerHTML = '';

            // Crea un array con i dati di riepilogo
            const summaryData = gameState.players.map(player => {
                const initial = gameState.initialChips[player.id] || 0;
                const current = player.chips;
                const profit = current - initial;
                const profitPercent = initial > 0 ? ((profit / initial) * 100).toFixed(1) : 0;
                
                return {
                    player,
                    initial,
                    current,
                    profit,
                    profitPercent,
                    isWinner: profit > 0,
                    isLoser: profit < 0
                };
            });

            // Ordina per profitto (dal maggiore al minore)
            summaryData.sort((a, b) => b.profit - a.profit);

            summaryData.forEach(data => {
                const div = document.createElement('div');
                div.className = `player-summary ${data.isWinner ? 'winner' : data.isLoser ? 'loser' : ''}`;
                
                const stats = gameState.playerStats[data.player.id] || {};
                const foldPreFlopPercent = stats.handsPlayed > 0 ? 
                    ((stats.foldPreFlop / stats.handsPlayed) * 100).toFixed(1) : 0;
                const winShowdownPercent = stats.showdownParticipations > 0 ?
                    ((stats.showdownWins / stats.showdownParticipations) * 100).toFixed(1) : 0;
                
                div.innerHTML = `
                    <div class="summary-player-name">
                        ${data.isWinner ? 'üèÜ ' : ''}${data.player.name}${data.isLoser ? ' üí∏' : ''}
                    </div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-label">Chips Iniziali</div>
                            <div>${data.initial}${formatEuroValue(data.initial)}</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Chips Finali</div>
                            <div>${data.current}${formatEuroValue(data.current)}</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Profitto/Perdita</div>
                            <div class="${data.profit > 0 ? 'profit' : data.profit < 0 ? 'loss' : ''}">
                                ${data.profit > 0 ? '+' : ''}${data.profit}${formatEuroValue(Math.abs(data.profit))}
                            </div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Percentuale</div>
                            <div class="${data.profit > 0 ? 'profit' : data.profit < 0 ? 'loss' : ''}">
                                ${data.profitPercent > 0 ? '+' : ''}${data.profitPercent}%
                            </div>
                        </div>
                    </div>
                    <div class="summary-stats" style="margin-top: 10px; border-top: 1px solid rgba(255, 215, 0, 0.2); padding-top: 10px;">
                        <div class="summary-stat">
                            <div class="summary-stat-label">Mani Giocate</div>
                            <div>${stats.handsPlayed || 0}</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">% Fold Pre-Flop</div>
                            <div>${foldPreFlopPercent}%</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">% Win Showdown</div>
                            <div class="${winShowdownPercent > 50 ? 'profit' : ''}">${winShowdownPercent}%</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Rebuy Totali</div>
                            <div>${stats.totalRebuys || 0}${formatEuroValue(stats.totalRebuys || 0)}</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-label">Volte Broke</div>
                            <div>${stats.timesBroke || 0}</div>
                        </div>
                    </div>
                `;
                
                summaryPlayers.appendChild(div);
            });

            document.getElementById('summaryScreen').style.display = 'flex';
            
            // Disegna il grafico dopo che il modal √® visibile
            setTimeout(() => {
                drawStackChart('stackChartCanvas');
            }, 100);
            
            hapticFeedback('success');
        }

        function closeSummary() {
            document.getElementById('summaryScreen').style.display = 'none';
        }

        function exportJSON() {
            // Prepara i dati per l'export
            const exportData = {
                sessionInfo: {
                    date: new Date().toISOString(),
                    dateFormatted: new Date().toLocaleString('it-IT'),
                    totalHands: gameState.handCount,
                    blindMode: gameState.blindMode,
                    anteAmount: gameState.anteAmount,
                    smallBlind: gameState.smallBlind,
                    bigBlind: gameState.bigBlind,
                    chipValue: gameState.chipValue
                },
                players: gameState.players.map(player => {
                    const stats = gameState.playerStats[player.id] || {};
                    const initial = gameState.initialChips[player.id] || 0;
                    const profit = player.chips - initial;
                    const profitPercent = initial > 0 ? ((profit / initial) * 100).toFixed(2) : 0;
                    const foldPreFlopPercent = stats.handsPlayed > 0 ?
                        ((stats.foldPreFlop / stats.handsPlayed) * 100).toFixed(2) : 0;
                    const winShowdownPercent = stats.showdownParticipations > 0 ?
                        ((stats.showdownWins / stats.showdownParticipations) * 100).toFixed(2) : 0;
                    
                    return {
                        name: player.name,
                        chipsInitial: initial,
                        chipsFinal: player.chips,
                        profit: profit,
                        profitPercent: parseFloat(profitPercent),
                        profitEuro: gameState.chipValue > 0 ? (profit / gameState.chipValue).toFixed(2) : null,
                        statistics: {
                            handsPlayed: stats.handsPlayed || 0,
                            foldPreFlop: stats.foldPreFlop || 0,
                            foldPreFlopPercent: parseFloat(foldPreFlopPercent),
                            foldFlop: stats.foldFlop || 0,
                            foldTurn: stats.foldTurn || 0,
                            foldRiver: stats.foldRiver || 0,
                            showdownWins: stats.showdownWins || 0,
                            showdownParticipations: stats.showdownParticipations || 0,
                            winShowdownPercent: parseFloat(winShowdownPercent),
                            totalRebuys: stats.totalRebuys || 0,
                            rebuyCount: player.rebuyCount || 0,
                            timesBroke: stats.timesBroke || 0
                        }
                    };
                }),
                stackHistory: gameState.stackHistory
            };
            
            // Crea il blob JSON
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Crea link per download
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            a.download = `poker_session_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            hapticFeedback('success');
            alert('Export JSON completato! Il file √® stato scaricato.');
        }

        function saveStackSnapshot() {
            const snapshot = {
                hand: gameState.handCount,
                stacks: {}
            };
            
            gameState.players.forEach(player => {
                snapshot.stacks[player.id] = player.chips;
            });
            
            gameState.stackHistory.push(snapshot);
        }

        function drawStackChart(containerId) {
            const container = document.getElementById(containerId);
            if (!container || gameState.stackHistory.length < 2) return;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'chart-canvas';
            canvas.width = container.offsetWidth || 300;
            canvas.height = 200;
            
            const ctx = canvas.getContext('2d');
            
            // Colori per ogni giocatore
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                '#4BC0C0', '#FF6384'
            ];
            
            // Trova min e max per scala Y
            let maxChips = 0;
            let minChips = Infinity;
            
            gameState.stackHistory.forEach(snapshot => {
                Object.values(snapshot.stacks).forEach(chips => {
                    maxChips = Math.max(maxChips, chips);
                    minChips = Math.min(minChips, chips);
                });
            });
            
            // Padding per il grafico
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            
            // Disegna assi
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
            
            // Disegna griglia orizzontale
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.2)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
                
                // Labels Y
                const value = Math.round(maxChips - (maxChips - minChips) * (i / 5));
                ctx.fillStyle = '#aaa';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(value.toString(), padding - 5, y + 3);
            }
            
            // Disegna linee per ogni giocatore
            gameState.players.forEach((player, playerIndex) => {
                ctx.strokeStyle = colors[playerIndex % colors.length];
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let firstPoint = true;
                gameState.stackHistory.forEach((snapshot, index) => {
                    const chips = snapshot.stacks[player.id] || 0;
                    const x = padding + (chartWidth / (gameState.stackHistory.length - 1)) * index;
                    const y = canvas.height - padding - ((chips - minChips) / (maxChips - minChips || 1)) * chartHeight;
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                
                ctx.stroke();
            });
            
            // Labels X
            ctx.fillStyle = '#aaa';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Inizio', padding, canvas.height - padding + 15);
            ctx.fillText(`Mano ${gameState.handCount}`, canvas.width - padding, canvas.height - padding + 15);
            
            container.innerHTML = '';
            container.appendChild(canvas);
            
            // Aggiungi legenda
            const legend = document.createElement('div');
            legend.className = 'chart-legend';
            
            gameState.players.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'chart-legend-item';
                item.innerHTML = `
                    <div class="chart-legend-color" style="background: ${colors[index % colors.length]}"></div>
                    <span>${player.name}</span>
                `;
                legend.appendChild(item);
            });
            
            container.appendChild(legend);
        }

        function updateUndoButton() {
            const undoButton = document.getElementById('undoButton');
            if (undoButton) {
                if (gameState.history.length > 0) {
                    undoButton.style.opacity = '1';
                    undoButton.style.borderColor = '#FFC107';
                    undoButton.style.color = '#FFC107';
                } else {
                    undoButton.style.opacity = '0.5';
                    undoButton.style.borderColor = '#ffd700';
                    undoButton.style.color = '#ffd700';
                }
            }
        }

        function renderPlayers() {
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            // Calcola la puntata massima corrente per determinare se un giocatore pu√≤ fare check
            const maxBet = Math.max(...gameState.players.map(p => p.bet), 0);
            
            // Conta i giocatori attivi
            const activePlayers = gameState.players.filter(p => !p.folded);
            const isLastActive = activePlayers.length === 1;

            gameState.players.forEach((player, index) => {
                const isDealer = index === gameState.dealerIndex;
                const isSmallBlind = gameState.blindMode === 'blinds' && index === (gameState.dealerIndex + 1) % gameState.players.length;
                const isBigBlind = gameState.blindMode === 'blinds' && index === (gameState.dealerIndex + 2) % gameState.players.length;
                const hasBet = player.bet > 0;
                const isFolded = player.folded;
                const hasChecked = player.hasChecked;
                const canCheck = player.bet === maxBet; // Pu√≤ fare check se ha gi√† pareggiato la puntata massima
                const canFold = !isLastActive || isFolded; // Non pu√≤ foldare se √® l'ultimo attivo
                const needsToCall = player.bet < maxBet; // Deve chiamare se ha puntato meno del massimo
                const callAmount = maxBet - player.bet; // Importo da chiamare

                const card = document.createElement('div');
                card.className = `player-card ${isDealer ? 'is-dealer' : ''} ${hasBet ? 'has-bet' : ''} ${isFolded ? 'folded' : ''} ${hasChecked ? 'checked' : ''}`;
                
                // Generate quick bet amounts
                const quickAmounts = [10, 25, 50, 100, 250, 500].filter(amt => amt <= player.chips);
                if (quickAmounts.length === 0 && player.chips > 0) {
                    quickAmounts.push(player.chips);
                }
                const displayAmounts = quickAmounts.slice(0, 3);
                
                const quickBetsHtml = displayAmounts.map(amt => 
                    `<button class="btn-quick-player-bet" onclick="quickBet(${player.id}, ${amt})" ${isFolded ? 'disabled' : ''}>${amt}</button>`
                ).join('');
                
                card.innerHTML = `
                    ${isDealer ? '<div class="dealer-badge">D</div>' : ''}
                    ${isSmallBlind ? '<div class="blind-badge">SB</div>' : ''}
                    ${isBigBlind ? '<div class="blind-badge big">BB</div>' : ''}
                    ${isFolded ? '<div class="fold-badge">FOLD</div>' : ''}
                    ${hasChecked && !isFolded ? '<div class="check-badge">‚úì CHECK</div>' : ''}
                    <div class="player-name">${player.name}</div>
                    <div class="player-chips" id="chips-${player.id}">üí∞ ${player.chips}${formatEuroValue(player.chips)}</div>
                    <div class="player-bet">${player.bet > 0 ? `Puntata: ${player.bet}` : ''}</div>
                    ${!isFolded ? `
                        <div class="player-actions">
                            ${player.chips > 0 ? `
                                <div class="quick-bet-row">
                                    ${quickBetsHtml}
                                </div>
                                <div class="advanced-actions">
                                    <button class="btn-bet" onclick="openBetModal(${player.id})">Altro...</button>
                                    <button class="btn-allin" onclick="openAllinModal(${player.id})">All-In</button>
                                </div>
                                ${needsToCall && callAmount > 0 ? `
                                    <div class="secondary-actions">
                                        <button class="btn-call" onclick="callBet(${player.id})" ${callAmount > player.chips ? 'disabled style="opacity: 0.5;"' : ''}>
                                            Call ${callAmount}
                                        </button>
                                        <button class="btn-fold" onclick="confirmFold(${player.id})">Fold</button>
                                    </div>
                                ` : `
                                    <div class="tertiary-actions">
                                        ${canCheck ? 
                                            `<button class="btn-check" onclick="checkPlayer(${player.id})">Check</button>` : 
                                            `<button class="btn-check" onclick="checkPlayer(${player.id})" disabled style="opacity: 0.5;">Check</button>`
                                        }
                                        ${canFold ? 
                                            `<button class="btn-fold" onclick="confirmFold(${player.id})">Fold</button>` : 
                                            `<button class="btn-fold" disabled style="opacity: 0.3; cursor: not-allowed;">Fold</button>`
                                        }
                                    </div>
                                `}
                            ` : ''}
                            ${player.chips <= 100 ? `
                                <button class="btn-rebuy" onclick="openRebuyModal(${player.id})">
                                    üí∞ Rebuy ${player.chips === 0 ? '(Broke)' : '(Low)'}
                                </button>
                            ` : ''}
                            <button class="btn-edit-chips" onclick="openEditChipsModal(${player.id})">
                                ‚úèÔ∏è Modifica Chips
                            </button>
                        </div>
                    ` : '<div style="text-align: center; padding: 10px; color: #999;">Fuori dalla mano</div>'}
                `;
                
                grid.appendChild(card);
            });
        }

        function updateGameHeader() {
            const potElement = document.getElementById('potAmount');
            potElement.innerHTML = `${gameState.pot}${formatEuroValue(gameState.pot)}`;
            document.getElementById('phaseName').textContent = gameState.phase;
            document.getElementById('dealerName').textContent = gameState.players[gameState.dealerIndex].name;
        }

        // Betting Functions
        function quickBet(playerId, amount) {
            const player = gameState.players[playerId];

            if (player.folded) {
                alert('Questo giocatore ha fatto fold!');
                return;
            }

            if (amount > player.chips) {
                alert('Chips insufficienti!');
                hapticFeedback('error');
                return;
            }

            // Save to history for undo
            gameState.history.push({
                type: 'bet',
                playerId: playerId,
                amount: amount,
                phase: gameState.phase
            });

            player.chips -= amount;
            player.bet += amount;
            gameState.pot += amount;
            player.hasActed = true;

            // Se qualcuno punta, rimuovi i badge check da tutti (la situazione √® cambiata)
            if (amount > 0) {
                gameState.players.forEach(p => p.hasChecked = false);
            }

            // Log
            addLog(`${player.name} punta ${amount}`, 'bet');

            // Update current call
            if (player.bet > gameState.currentCall) {
                gameState.currentCall = player.bet;
            }

            animateChipChange(playerId, 'loss');
            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('light');
            playSound('bet');
        }

        function openBetModal(playerId) {
            currentBetPlayer = playerId;
            const player = gameState.players[playerId];
            
            document.getElementById('betModalTitle').textContent = `Puntata - ${player.name}`;
            document.getElementById('betInput').value = '';
            document.getElementById('betInput').max = player.chips;

            // Generate quick bet buttons
            const quickBetsContainer = document.getElementById('quickBets');
            quickBetsContainer.innerHTML = '';
            
            const quickAmounts = [10, 25, 50, 100, 250, 500].filter(amt => amt <= player.chips);
            if (quickAmounts.length === 0) quickAmounts.push(player.chips);
            
            quickAmounts.forEach(amount => {
                const btn = document.createElement('button');
                btn.className = 'btn-quick-bet';
                btn.textContent = amount;
                btn.onclick = () => {
                    document.getElementById('betInput').value = amount;
                    hapticFeedback('light');
                };
                quickBetsContainer.appendChild(btn);
            });

            document.getElementById('betModal').classList.add('active');
            hapticFeedback('light');
        }

        function closeBetModal() {
            document.getElementById('betModal').classList.remove('active');
            currentBetPlayer = null;
        }

        function confirmBet() {
            const amount = parseInt(document.getElementById('betInput').value);
            const player = gameState.players[currentBetPlayer];

            if (!amount || amount <= 0) {
                alert('Inserisci un importo valido');
                return;
            }

            if (amount > player.chips) {
                alert('Chips insufficienti!');
                return;
            }

            // Save to history for undo
            gameState.history.push({
                type: 'bet',
                playerId: currentBetPlayer,
                amount: amount,
                phase: gameState.phase
            });

            player.chips -= amount;
            player.bet += amount;
            gameState.pot += amount;
            player.hasActed = true;

            // Log
            addLog(`${player.name} punta ${amount}`, 'bet');

            // Se qualcuno punta, rimuovi i badge check da tutti
            if (amount > 0) {
                gameState.players.forEach(p => p.hasChecked = false);
            }

            // Update current call
            if (player.bet > gameState.currentCall) {
                gameState.currentCall = player.bet;
            }

            animateChipChange(currentBetPlayer, 'loss');
            closeBetModal();
            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('medium');
            playSound('bet');
        }

        function openAllinModal(playerId) {
            currentAllinPlayer = playerId;
            const player = gameState.players[playerId];

            document.getElementById('allinMessage').textContent = 
                `${player.name} andr√† All-In con ${player.chips} chips. Confermare?`;
            
            document.getElementById('allinModal').classList.add('active');
            hapticFeedback('heavy');
        }

        function closeAllinModal() {
            document.getElementById('allinModal').classList.remove('active');
            currentAllinPlayer = null;
        }

        function confirmAllin() {
            const player = gameState.players[currentAllinPlayer];
            const amount = player.chips;

            if (amount <= 0) {
                alert('Il giocatore non ha chips!');
                closeAllinModal();
                return;
            }

            // Save to history
            gameState.history.push({
                type: 'allin',
                playerId: currentAllinPlayer,
                amount: amount,
                phase: gameState.phase
            });

            player.bet += amount;
            gameState.pot += amount;
            player.chips = 0;
            player.hasActed = true;

            // Log
            addLog(`${player.name} va All-In con ${amount}!`, 'bet');

            // Se qualcuno va all-in, rimuovi i badge check da tutti
            if (amount > 0) {
                gameState.players.forEach(p => p.hasChecked = false);
            }

            // Update current call
            if (player.bet > gameState.currentCall) {
                gameState.currentCall = player.bet;
            }

            animateChipChange(currentAllinPlayer, 'loss');
            closeAllinModal();
            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('heavy');
            playSound('bet');
        }

        function animateChipChange(playerId, type) {
            const element = document.getElementById(`chips-${playerId}`);
            if (element) {
                element.classList.add(`chip-animation-${type}`);
                setTimeout(() => {
                    element.classList.remove(`chip-animation-${type}`);
                }, 500);
            }
        }

        function foldPlayer(playerId) {
            const player = gameState.players[playerId];
            
            if (player.folded) {
                return;
            }

            // Controlla quanti giocatori sono ancora attivi
            const activePlayers = gameState.players.filter(p => !p.folded);
            
            if (activePlayers.length === 1) {
                alert('Non puoi foldare! Sei l\'unico giocatore rimasto in gioco.');
                hapticFeedback('error');
                return;
            }

            // Save to history
            gameState.history.push({
                type: 'fold',
                playerId: playerId,
                phase: gameState.phase
            });

            player.folded = true;
            player.hasActed = true;

            // Traccia statistiche fold per fase
            if (gameState.playerStats[playerId]) {
                if (gameState.phase === 'Pre-Flop') {
                    gameState.playerStats[playerId].foldPreFlop++;
                } else if (gameState.phase === 'Flop') {
                    gameState.playerStats[playerId].foldFlop++;
                } else if (gameState.phase === 'Turn') {
                    gameState.playerStats[playerId].foldTurn++;
                } else if (gameState.phase === 'River') {
                    gameState.playerStats[playerId].foldRiver++;
                }
            }

            // Log
            addLog(`${player.name} folda`, 'fold');

            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('light');
            playSound('bet');

            // Check if only one player remains after this fold
            const remainingPlayers = gameState.players.filter(p => !p.folded);
            if (remainingPlayers.length === 1) {
                setTimeout(() => {
                    const winner = remainingPlayers[0];
                    hapticFeedback('success');
                    playSound('win');
                    
                    if (confirm(`üèÜ ${winner.name} vince per fold! Tutti gli altri hanno passato.\n\nAssegnare il piatto di ${gameState.pot} chips?`)) {
                        assignPot(winner.id);
                    }
                }, 300);
            }
        }

        function checkPlayer(playerId) {
            const player = gameState.players[playerId];
            
            if (player.folded) {
                return;
            }

            // Verifica che il giocatore possa effettivamente fare check
            const maxBet = Math.max(...gameState.players.map(p => p.bet), 0);
            
            if (player.bet !== maxBet) {
                alert('Non puoi fare check! Devi pareggiare la puntata corrente.');
                hapticFeedback('error');
                return;
            }

            // Save to history
            gameState.history.push({
                type: 'check',
                playerId: playerId,
                phase: gameState.phase
            });

            player.hasActed = true;
            player.hasChecked = true;

            // Log
            addLog(`${player.name} fa check`, 'check');

            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('light');
            playSound('bet');
        }

        function callBet(playerId) {
            const player = gameState.players[playerId];
            
            if (player.folded) {
                return;
            }

            // Calcola quanto deve chiamare
            const maxBet = Math.max(...gameState.players.map(p => p.bet), 0);
            const callAmount = maxBet - player.bet;

            if (callAmount <= 0) {
                alert('Non c\'√® nulla da chiamare!');
                hapticFeedback('error');
                return;
            }

            if (callAmount > player.chips) {
                alert('Chips insufficienti per chiamare! Usa All-In.');
                hapticFeedback('error');
                return;
            }

            // Save to history
            gameState.history.push({
                type: 'bet',
                playerId: playerId,
                amount: callAmount,
                phase: gameState.phase
            });

            player.chips -= callAmount;
            player.bet += callAmount;
            gameState.pot += callAmount;
            player.hasActed = true;

            // Log
            addLog(`${player.name} chiama ${callAmount}`, 'bet');

            // Rimuovi i badge check quando qualcuno chiama
            gameState.players.forEach(p => p.hasChecked = false);

            // Update current call
            if (player.bet > gameState.currentCall) {
                gameState.currentCall = player.bet;
            }

            animateChipChange(playerId, 'loss');
            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('medium');
            playSound('bet');
        }

        function confirmFold(playerId) {
            const player = gameState.players[playerId];
            
            if (confirm(`Confermare fold per ${player.name}?`)) {
                foldPlayer(playerId);
            }
        }

        function checkPhaseReady() {
            // Controlla se tutti i giocatori attivi hanno agito e pareggiato la puntata
            // Esclude giocatori foldati E giocatori senza chips (broke)
            const activePlayers = gameState.players.filter(p => !p.folded && p.chips > 0);
            
            if (activePlayers.length === 0) {
                // Tutti i giocatori sono all-in o foldati - la fase √® pronta
                document.getElementById('phaseName').style.color = '#4CAF50';
                return;
            }

            // Se c'√® un solo giocatore attivo con chips (gli altri sono all-in o foldati)
            if (activePlayers.length === 1) {
                const player = activePlayers[0];
                const allNonFoldedPlayers = gameState.players.filter(p => !p.folded);
                const maxBet = Math.max(...allNonFoldedPlayers.map(p => p.bet));
                
                // Il giocatore deve aver agito E pareggiato la puntata massima
                if (player.hasActed && player.bet === maxBet) {
                    document.getElementById('phaseName').style.color = '#4CAF50';
                    return;
                }
            }

            // Trova la puntata massima tra TUTTI i giocatori non foldati (inclusi all-in)
            const allNonFoldedPlayers = gameState.players.filter(p => !p.folded);
            const maxBet = Math.max(...allNonFoldedPlayers.map(p => p.bet));
            
            // Tutti devono aver agito
            const allActed = activePlayers.every(p => p.hasActed);
            
            // Tutti i giocatori attivi devono aver puntato la puntata massima
            const allMatched = activePlayers.every(p => p.bet === maxBet);

            if (allActed && allMatched) {
                // Tutti hanno agito e pareggiato - abilita prossima fase
                document.getElementById('phaseName').style.color = '#4CAF50';
            } else {
                document.getElementById('phaseName').style.color = '#fff';
            }
        }

        // Phase Management
        function nextPhase() {
            // Controlla se tutti i giocatori attivi hanno agito
            // Esclude giocatori foldati E giocatori senza chips (broke)
            const activePlayers = gameState.players.filter(p => !p.folded && p.chips > 0);
            
            // Caso speciale: tutti all-in o un solo giocatore con chips
            if (activePlayers.length === 0) {
                // Tutti sono all-in, procedi direttamente
            } else if (activePlayers.length === 1) {
                // Un solo giocatore pu√≤ agire, gli altri sono all-in o foldati
                const player = activePlayers[0];
                const allNonFoldedPlayers = gameState.players.filter(p => !p.folded);
                const maxBet = Math.max(...allNonFoldedPlayers.map(p => p.bet));
                
                // Il giocatore deve aver agito
                if (!player.hasActed) {
                    alert('Il giocatore deve agire!');
                    hapticFeedback('error');
                    return;
                }
                
                // Il giocatore deve aver pareggiato la puntata massima
                // (inclusi gli all-in degli altri)
                if (player.bet !== maxBet) {
                    alert('Il giocatore deve pareggiare la puntata massima!');
                    hapticFeedback('error');
                    return;
                }
                // Se ha pareggiato, procedi
            } else if (activePlayers.length > 1) {
                // Pi√π giocatori attivi, controllo normale
                // IMPORTANTE: La puntata massima deve considerare TUTTI i giocatori non foldati
                // inclusi quelli all-in, altrimenti si pu√≤ passare fase con puntate diverse
                const allNonFoldedPlayers = gameState.players.filter(p => !p.folded);
                const maxBet = Math.max(...allNonFoldedPlayers.map(p => p.bet));
                
                const allActed = activePlayers.every(p => p.hasActed);
                // I giocatori attivi devono aver pareggiato la puntata MASSIMA (incluso all-in)
                const allMatched = activePlayers.every(p => p.bet === maxBet);

                if (!allActed) {
                    alert('Non tutti i giocatori hanno agito!');
                    hapticFeedback('error');
                    return;
                }

                if (!allMatched) {
                    alert('Non tutti i giocatori hanno pareggiato la puntata massima!');
                    hapticFeedback('error');
                    return;
                }
            }

            const currentIndex = PHASES.indexOf(gameState.phase);
            if (currentIndex < PHASES.length - 1) {
                gameState.phase = PHASES[currentIndex + 1];
                
                // Log
                addLog(`‚ûú ${gameState.phase}`, 'phase');
                
                // Reset per la nuova fase
                gameState.players.forEach(p => {
                    p.hasActed = false;
                    p.bet = 0; // Azzera la puntata visualizzata
                    p.hasChecked = false; // Rimuovi i badge check
                });
                gameState.currentCall = 0; // Reset della puntata massima
                
                renderGame();
                // Reset del colore della fase a bianco
                document.getElementById('phaseName').style.color = '#fff';
                saveGame();
                hapticFeedback('medium');
                playSound('phase');
            } else {
                // Siamo gi√† allo Showdown
                alert('Sei gi√† allo Showdown. Usa "Assegna Piatto" per concludere la mano.');
                hapticFeedback('error');
            }
        }

        function nextDealer() {
            gameState.dealerIndex = (gameState.dealerIndex + 1) % gameState.players.length;
            renderGame();
            saveGame();
            hapticFeedback('light');
        }

        function resetHand() {
            // Non serve conferma se siamo allo Showdown e il piatto √® gi√† stato assegnato
            const needsConfirm = gameState.pot > 0 || gameState.phase !== 'Showdown';
            
            if (needsConfirm && !confirm('Iniziare una nuova mano? (Le puntate attuali saranno perse)')) {
                return;
            }

            // Passa al dealer successivo PRIMA di resettare
            gameState.dealerIndex = (gameState.dealerIndex + 1) % gameState.players.length;

            // Reset bets and status PRIMA di applicare l'ante
            gameState.players.forEach(player => {
                player.bet = 0;
                player.folded = false;
                player.hasActed = false;
                player.hasChecked = false;
            });

            gameState.phase = 'Pre-Flop';
            gameState.currentBets = {};
            gameState.currentCall = 0;
            gameState.history = [];
            gameState.pot = 0; // Reset del piatto

            // Apply ante or blinds - DOPO aver resettato tutto
            if (gameState.blindMode === 'ante' && gameState.anteAmount > 0) {
                // Modalit√† Ante: tutti pagano
                gameState.players.forEach(player => {
                    if (player.chips >= gameState.anteAmount) {
                        player.chips -= gameState.anteAmount;
                        player.bet = gameState.anteAmount;
                        gameState.pot += gameState.anteAmount;
                    }
                });
                gameState.currentCall = gameState.anteAmount;
            } else if (gameState.blindMode === 'blinds') {
                // Modalit√† Blinds: solo SB e BB pagano
                const sbIndex = (gameState.dealerIndex + 1) % gameState.players.length;
                const bbIndex = (gameState.dealerIndex + 2) % gameState.players.length;
                
                // Small Blind
                const sbPlayer = gameState.players[sbIndex];
                if (sbPlayer.chips >= gameState.smallBlind) {
                    sbPlayer.chips -= gameState.smallBlind;
                    sbPlayer.bet = gameState.smallBlind;
                    gameState.pot += gameState.smallBlind;
                }
                
                // Big Blind
                const bbPlayer = gameState.players[bbIndex];
                if (bbPlayer.chips >= gameState.bigBlind) {
                    bbPlayer.chips -= gameState.bigBlind;
                    bbPlayer.bet = gameState.bigBlind;
                    gameState.pot += gameState.bigBlind;
                }
                
                gameState.currentCall = gameState.bigBlind;
                addLog(`üí∞ Small Blind (${sbPlayer.name}): ${gameState.smallBlind} chips`, 'phase');
                addLog(`üí∞ Big Blind (${bbPlayer.name}): ${gameState.bigBlind} chips`, 'phase');
            }

            renderGame();
            // Reset del colore della fase a bianco
            document.getElementById('phaseName').style.color = '#fff';
            
            // Incrementa contatore mani e salva snapshot
            gameState.handCount++;
            
            // Incrementa handsPlayed per tutti i giocatori
            gameState.players.forEach(p => {
                if (gameState.playerStats[p.id]) {
                    gameState.playerStats[p.id].handsPlayed++;
                }
            });
            
            saveStackSnapshot();
            
            // Log
            addLog(`üîÑ Nuova mano - Dealer: ${gameState.players[gameState.dealerIndex].name}`, 'phase');
            
            saveGame();
            hapticFeedback('success');
            playSound('phase');
        }

        function undoLastBet() {
            if (gameState.history.length === 0) {
                alert('Nessuna azione da annullare');
                hapticFeedback('error');
                return;
            }

            const lastAction = gameState.history.pop();
            const player = gameState.players[lastAction.playerId];

            if (lastAction.type === 'fold') {
                // Annulla fold
                player.folded = false;
                player.hasActed = false;
            } else if (lastAction.type === 'check') {
                // Annulla check
                player.hasActed = false;
                player.hasChecked = false;
            } else if (lastAction.type === 'bet' || lastAction.type === 'allin') {
                // Annulla puntata o all-in
                player.chips += lastAction.amount;
                player.bet -= lastAction.amount;
                gameState.pot -= lastAction.amount;
                player.hasActed = false;
                
                // Ricalcola currentCall
                gameState.currentCall = Math.max(...gameState.players.map(p => p.bet), 0);
            }

            renderGame();
            checkPhaseReady();
            saveGame();
            hapticFeedback('medium');
            playSound('bet');
        }

        // Winner Selection
        function openWinnerModal() {
            if (gameState.pot === 0) {
                alert('Il piatto √® vuoto!');
                return;
            }

            const winnerList = document.getElementById('winnerList');
            winnerList.innerHTML = '';

            // Aggiungi opzione Split Pot
            const splitOption = document.createElement('div');
            splitOption.className = 'winner-option';
            splitOption.style.background = 'rgba(255, 193, 7, 0.2)';
            splitOption.style.borderColor = '#FFC107';
            splitOption.onclick = () => {
                closeWinnerModal();
                openSplitPotModal();
            };
            splitOption.innerHTML = `
                <div class="winner-option-name">‚ûó Dividi Piatto (Split)</div>
                <div class="winner-option-chips">Per vincite multiple</div>
            `;
            winnerList.appendChild(splitOption);

            // Mostra solo giocatori che non hanno foldato
            const activePlayers = gameState.players.filter(p => !p.folded);

            if (activePlayers.length === 0) {
                alert('Tutti i giocatori hanno fatto fold!');
                return;
            }

            activePlayers.forEach(player => {
                const option = document.createElement('div');
                option.className = 'winner-option';
                option.onclick = () => assignPot(player.id);
                option.innerHTML = `
                    <div class="winner-option-name">${player.name}</div>
                    <div class="winner-option-chips">Chips attuali: ${player.chips}</div>
                `;
                winnerList.appendChild(option);
            });

            document.getElementById('winnerModal').classList.add('active');
            hapticFeedback('light');
        }

        function closeWinnerModal() {
            document.getElementById('winnerModal').classList.remove('active');
        }

        function assignPot(playerId) {
            const player = gameState.players[playerId];
            const potAmount = gameState.pot;
            player.chips += potAmount;
            
            // Traccia vittoria showdown se siamo allo showdown
            if (gameState.phase === 'Showdown' && gameState.playerStats[playerId]) {
                gameState.playerStats[playerId].showdownWins++;
            }
            
            // Traccia partecipazione showdown per tutti i non-foldati
            if (gameState.phase === 'Showdown') {
                gameState.players.forEach(p => {
                    if (!p.folded && gameState.playerStats[p.id]) {
                        gameState.playerStats[p.id].showdownParticipations++;
                    }
                });
            }
            
            // Log
            addLog(`üèÜ ${player.name} vince il piatto: ${potAmount} chips`, 'win');
            
            animateChipChange(playerId, 'gain');
            
            gameState.pot = 0;
            gameState.currentCall = 0;
            gameState.players.forEach(p => {
                p.bet = 0;
                p.folded = false;
                p.hasActed = false;
                p.hasChecked = false;
            });
            
            closeWinnerModal();
            renderGame();
            saveStackSnapshot(); // Salva snapshot dopo vittoria
            saveGame();
            hapticFeedback('success');
            playSound('win');

            setTimeout(() => {
                if (confirm(`${player.name} ha vinto! Iniziare nuova mano?`)) {
                    resetHand();
                }
            }, 500);
        }

        // Settings
        function openSettings() {
            document.getElementById('settingsAnte').value = gameState.anteAmount;
            document.getElementById('settingsChipValue').value = gameState.chipValue || 0;
            document.getElementById('settingsNumPlayers').value = gameState.players.length;
            
            updateSettingsPlayerInputs();
            updateRebuyManagementList();
            document.getElementById('settingsModal').classList.add('active');
            hapticFeedback('light');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function updateRebuyManagementList() {
            const container = document.getElementById('rebuyManagementList');
            container.innerHTML = '';

            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'rebuy-player-item';
                
                const totalSpent = (gameState.initialChips[player.id] || 0) + (player.totalRebuys || 0);
                
                div.innerHTML = `
                    <div class="rebuy-player-info">
                        <div class="rebuy-player-name">${player.name}</div>
                        <div class="rebuy-player-stats">
                            Rebuy: <span class="highlight">${player.rebuyCount || 0}x</span> 
                            | Totale: <span class="highlight">${player.totalRebuys || 0}</span> chips
                            | Spesa totale: <span class="highlight">${totalSpent}</span> chips
                        </div>
                    </div>
                    <button class="btn-rebuy-settings" onclick="openRebuyFromSettings(${player.id})">
                        + Rebuy
                    </button>
                `;
                
                container.appendChild(div);
            });
            
            // Aggiorna anche il totale chips
            updateTotalChipsDisplay();
        }

        function updateTotalChipsDisplay() {
            const container = document.getElementById('totalChipsDisplay');
            if (!container) return;
            
            // Calcola chips totali dei giocatori
            const totalPlayerChips = gameState.players.reduce((sum, player) => sum + player.chips, 0);
            
            // Aggiungi il piatto
            const pot = gameState.pot || 0;
            
            // Totale generale
            const grandTotal = totalPlayerChips + pot;
            
            // Formatta con valori in euro se configurato
            const formatWithEuro = (chips) => {
                let text = chips.toString();
                if (gameState.chipValue > 0) {
                    const euros = (chips / gameState.chipValue).toFixed(2);
                    text += ` <span style="color: #aaa; font-size: 13px;">(${euros}‚Ç¨)</span>`;
                }
                return text;
            };
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                    <span style="color: #fff;">Chips Giocatori:</span>
                    <span style="color: #4CAF50; font-weight: bold;">${formatWithEuro(totalPlayerChips)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0, 0, 0, 0.2); border-radius: 4px;">
                    <span style="color: #fff;">Piatto:</span>
                    <span style="color: #FFC107; font-weight: bold;">${formatWithEuro(pot)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(255, 215, 0, 0.2); border-radius: 4px; border: 1px solid #ffd700;">
                    <span style="color: #ffd700; font-weight: bold;">TOTALE:</span>
                    <span style="color: #ffd700; font-weight: bold; font-size: 18px;">${formatWithEuro(grandTotal)}</span>
                </div>
            `;
        }

        function openRebuyFromSettings(playerId) {
            // Chiudi impostazioni e apri rebuy modal
            closeSettings();
            setTimeout(() => {
                openRebuyModal(playerId);
            }, 100);
        }

        function updateSettingsPlayerInputs() {
            const container = document.getElementById('settingsPlayerInputs');
            container.innerHTML = '';

            const currentNum = gameState.players.length;
            const newNum = parseInt(document.getElementById('settingsNumPlayers').value);

            for (let i = 0; i < newNum; i++) {
                const setting = document.createElement('div');
                setting.className = 'setting-item';
                
                const existingPlayer = i < currentNum ? gameState.players[i] : null;
                
                setting.innerHTML = `
                    <label class="setting-label">Giocatore ${i + 1}</label>
                    <input type="text" id="settingsPlayerName${i}" 
                           value="${existingPlayer ? existingPlayer.name : `Giocatore ${i + 1}`}"
                           placeholder="Nome giocatore ${i + 1}">
                `;
                container.appendChild(setting);
            }
        }

        document.getElementById('settingsNumPlayers').addEventListener('change', updateSettingsPlayerInputs);

        function applySettings() {
            const newAnte = parseInt(document.getElementById('settingsAnte').value);
            const newNum = parseInt(document.getElementById('settingsNumPlayers').value);
            const newChipValue = parseInt(document.getElementById('settingsChipValue').value) || 0;
            
            gameState.anteAmount = newAnte;
            gameState.chipValue = newChipValue;

            // Update player count
            const oldPlayers = [...gameState.players];
            gameState.players = [];

            for (let i = 0; i < newNum; i++) {
                const name = document.getElementById(`settingsPlayerName${i}`).value.trim() || `Giocatore ${i + 1}`;
                
                if (i < oldPlayers.length) {
                    // Keep existing player data
                    gameState.players.push({
                        ...oldPlayers[i],
                        name: name
                    });
                } else {
                    // Add new player
                    gameState.players.push({
                        id: i,
                        name: name,
                        chips: 1000,
                        bet: 0,
                        folded: false,
                        hasActed: false,
                        totalRebuys: 0,
                        rebuyCount: 0
                    });
                }
            }

            // Adjust dealer index if needed
            if (gameState.dealerIndex >= gameState.players.length) {
                gameState.dealerIndex = 0;
            }

            closeSettings();
            renderGame();
            saveGame();
            hapticFeedback('success');
            playSound('phase');
        }

        // Initialize
        updatePlayerInputs();

        // LocalStorage Functions
        function saveGame() {
            try {
                localStorage.setItem('pokerTrackerState', JSON.stringify(gameState));
            } catch (e) {
                console.error('Errore nel salvataggio:', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('pokerTrackerState');
                if (saved) {
                    const loaded = JSON.parse(saved);
                    // Verifica che ci siano giocatori salvati
                    if (loaded.players && loaded.players.length > 0) {
                        return loaded;
                    }
                }
            } catch (e) {
                console.error('Errore nel caricamento:', e);
            }
            return null;
        }

        function clearSavedGame() {
            try {
                localStorage.removeItem('pokerTrackerState');
            } catch (e) {
                console.error('Errore nella cancellazione:', e);
            }
        }

        // Check for saved game on load
        window.addEventListener('DOMContentLoaded', function() {
            const savedGame = loadGame();
            if (savedGame) {
                if (confirm('√à stata rilevata una partita salvata. Vuoi continuare?')) {
                    gameState = savedGame;
                    document.getElementById('setupScreen').style.display = 'none';
                    document.getElementById('gameScreen').style.display = 'block';
                    renderGame();
                    hapticFeedback('success');
                } else {
                    clearSavedGame();
                }
            }
        });
    </script>
</body>
</html>
